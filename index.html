<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Refill Pricing">
  <meta name="theme-color" content="#0f172a"/>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <title>Refill Pricing Calculator</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#f8fafc; --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --border:#334155 }
    * { box-sizing: border-box; }
    html, body { margin:0; overflow-x:hidden; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    .wrap { width:100%; max-width: 900px; margin: 0 auto; padding: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; position:sticky; top:0; background: linear-gradient(180deg, rgba(15,23,42,.95), rgba(15,23,42,.85)); backdrop-filter: blur(6px); padding:12px 0; z-index:10 }
    h1 { font-size: 20px; margin:0; letter-spacing:.2px }
    .btn { border:1px solid var(--border); background: #0b1220; color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600 }
    .btn:active { transform: translateY(1px); }
    .btn.accent { background: var(--accent); color:#052e16; border-color: #16a34a }
    .btn.ghost { background: transparent }
    .grid { display:grid; gap:12px }
    @media (min-width: 860px){ .grid.cols-2 { grid-template-columns: minmax(0,1fr) minmax(0,1fr) } }
    .card { background: var(--card); border:1px solid var(--border); border-radius:16px; padding:16px }
    .card h2 { margin:0 0 8px 0; font-size:16px }
    label { display:block; font-size:12px; color: var(--muted); margin-bottom:6px }
    input[type="number"], select { width:100%; max-width:100%; background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:12px; padding:12px; font-size:16px }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .muted { color: var(--muted) }
    .kpis { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px }
    .kpi { background:#0b1220; border:1px solid var(--border); border-radius:14px; padding:12px }
    .kpi .label { font-size:12px; color:var(--muted) }
    .kpi .value { font-size:18px; font-weight:800; margin-top:6px }
    .mini { font-size:12px }
    .line { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px dashed var(--border) }
    .line:last-child { border-bottom:none }
    .line span { overflow-wrap:anywhere; }
    .hidden { display:none }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Refill Pricing Calculator</h1>
      <div class="row">
        <button id="btnA2HS" class="btn accent">Add to Home Screen</button>
      </div>
    </header>

    <div class="grid cols-2">
      <section class="card">
        <h2>Selections</h2>
        <div class="grid">
          <div class="row mini">
            <input id="customerView" type="checkbox" />
            <label for="customerView" style="margin:0">Customer view (hide list & discount lines)</label>
          </div>
          <div>
            <label>Housing</label>
            <select id="housingSelect"></select>
          </div>
          <div>
            <label>Cartridge</label>
            <select id="cartridgeSelect"></select>
          </div>
          <div class="row">
            <div style="flex:1; min-width:180px">
              <label>Housing Pack</label>
              <select id="housingPack">
                <option value="each">Each</option>
                <option value="box">Box (20% off)</option>
              </select>
            </div>
            <div style="flex:1; min-width:180px">
              <label>Cartridge Pack</label>
              <select id="cartridgePack">
                <option value="each">Each</option>
                <option value="box">Box (20% off)</option>
              </select>
            </div>
          </div>
          <div>
            <label>Discount % (applies to both items)</label>
            <input id="discount" type="number" inputmode="decimal" step="0.5" min="0" max="60" value="0" />
          </div>
          <div>
            <label>Timeframe</label>
            <select id="qtyPeriod">
              <option value="day">per day</option>
              <option value="month">per month</option>
              <option value="year">per year</option>
            </select>
          </div>
          <div class="row">
            <div style="flex:1; min-width:160px">
              <label>Housing quantity</label>
              <input id="qtyHousing" type="number" inputmode="decimal" step="1" min="0" placeholder="e.g. 10" />
            </div>
            <div style="flex:1; min-width:160px">
              <label>Cartridge quantity</label>
              <input id="qtyCartridge" type="number" inputmode="decimal" step="1" min="0" placeholder="e.g. 50" />
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Pricing</h2>
        <div id="lineHousing" class="line"><span class="muted">Housing</span><span id="housingLine">—</span></div>
        <div id="lineHousingDisc" class="line"><span class="muted">Housing discount</span><span id="housingDisc">£0.00</span></div>
        <div class="line"><strong>Housing price</strong><strong id="housingAfter">£0.00</strong></div>
        <div id="lineCartridge" class="line"><span class="muted">Cartridge</span><span id="cartridgeLine">—</span></div>
        <div id="lineCartridgeDisc" class="line"><span class="muted">Cartridge discount</span><span id="cartridgeDisc">£0.00</span></div>
        <div class="line"><strong>Cartridge price</strong><strong id="cartridgeAfter">£0.00</strong></div>
        <div id="lineBase" class="line"><span class="muted">Base (before discount)</span><span id="base">£0.00</span></div>
        <div id="lineTotalDisc" class="line"><span class="muted">Total discount</span><span id="discountAmt">£0.00</span></div>
        <div class="line"><strong>Your price</strong><strong id="yourPrice">£0.00</strong></div>
        <div id="annualBlock" class="hidden" style="margin-top:10px">
          <div class="line"><span class="muted">Annual housing qty</span><span id="annualQtyHousing">0</span></div>
          <div class="line"><span class="muted">Annual cartridge qty</span><span id="annualQtyCartridge">0</span></div>
          <div class="line"><span class="muted">Housing × annual qty</span><span id="annualHousing">£0.00</span></div>
          <div class="line"><span class="muted">Cartridge × annual qty</span><span id="annualCartridge">£0.00</span></div>
          <div class="line"><strong>Annual total</strong><strong id="annualTotal">£0.00</strong></div>
        </div>
        <div class="kpis" style="margin-top:12px">
          <div class="kpi" id="discBox"><div class="label">Discount applied</div><div class="value" id="discBadge">0%</div></div>
        </div>
        <p class="mini muted" style="margin-top:8px">All numbers in GBP. Box prices are 20% off each list as provided.</p>
      </section>
    </div>

    <p class="mini muted" style="text-align:center;margin-top:14px">Tip: Use “Share → Add to Home Screen” on iOS/Android to use offline.</p>
  </div>

  <script>
    // ===== Data from spreadsheet =====
    const DATA = {
      housings: [
        { key:'none', name:'Housing in place (no cost)', listEach:0, listBox:0 },
        { key:'st-rh', name:'ST-RH: SPECTRUM Branded Serve Taste Refillable Housing', listEach:15.00, listBox:12.00 },
        { key:'stl-1-1-4-nl', name:'STL-1-1/4-NL: Unbranded/No Label Taste Refillable Housing', listEach:18.75, listBox:16.00 },
        { key:'private', name:'Private Branded Taste Refillable Housing', listEach:19.75, listBox:17.00 },
      ],
      cartridges: [
        { key:'st-rr', name:'ST-RR : SPECTRUM Serve Taste Refillable Replacement Cartridge', listEach:5.50, listBox:4.40 },
        { key:'stp-rr', name:'STP-RR : SPECTRUM Serve Taste Phosphate Refillable Replacement Cartridge', listEach:6.75, listBox:5.40 },
        { key:'stf-rr', name:'STF-RR : SPECTRUM Serve Taste FibreOnyx with Lentik™ Replacement Cartridge', listEach:16.00, listBox:12.80 },
        { key:'stfp-rr', name:'STFP-RR : SPECTRUM Serve Taste FibreOnyx with Phosphate Refillable Replacement Cartridge', listEach:17.25, listBox:13.80 },
        { key:'stfplus-rr', name:'STF+-RR : SPECTRUM Serve Taste FibreOnyx+ with Lentik™ Replacement Cartridge', listEach:20.50, listBox:16.40 },
        { key:'stfpplus-rr', name:'STFP+-RR : SPECTRUM Serve Taste FibreOnyx+ with Phosphate Refillable Replacement Cartridge', listEach:21.75, listBox:17.40 },
      ]
    }

    // ===== State & Elements =====
    const fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' })
    const state = JSON.parse(localStorage.getItem('refill_calc_v1')||'{}')
    Object.assign(state,{
      housingKey: state.housingKey||'none',
      housingPack: state.housingPack||'each',
      cartridgeKey: state.cartridgeKey||DATA.cartridges[0].key,
      cartridgePack: state.cartridgePack||'each',
      discount: Number.isFinite(+state.discount)? +state.discount : 0,
      customerView: !!state.customerView,
      qtyHousing: Number.isFinite(+state.qtyHousing)? +state.qtyHousing : 0,
      qtyCartridge: Number.isFinite(+state.qtyCartridge)? +state.qtyCartridge : 0,
      qtyPeriod: state.qtyPeriod||'day',
    })

    const els = {
      housingSelect: document.getElementById('housingSelect'),
      housingPack: document.getElementById('housingPack'),
      cartridgeSelect: document.getElementById('cartridgeSelect'),
      cartridgePack: document.getElementById('cartridgePack'),
      discount: document.getElementById('discount'),
      customerView: document.getElementById('customerView'),
      qtyHousing: document.getElementById('qtyHousing'),
      qtyCartridge: document.getElementById('qtyCartridge'),
      qtyPeriod: document.getElementById('qtyPeriod'),
      lineHousing: document.getElementById('lineHousing'),
      lineHousingDisc: document.getElementById('lineHousingDisc'),
      lineCartridge: document.getElementById('lineCartridge'),
      lineCartridgeDisc: document.getElementById('lineCartridgeDisc'),
      lineBase: document.getElementById('lineBase'),
      lineTotalDisc: document.getElementById('lineTotalDisc'),
      housingLine: document.getElementById('housingLine'),
      housingDisc: document.getElementById('housingDisc'),
      housingAfter: document.getElementById('housingAfter'),
      cartridgeLine: document.getElementById('cartridgeLine'),
      cartridgeDisc: document.getElementById('cartridgeDisc'),
      cartridgeAfter: document.getElementById('cartridgeAfter'),
      base: document.getElementById('base'),
      discountAmt: document.getElementById('discountAmt'),
      yourPrice: document.getElementById('yourPrice'),
      discBox: document.getElementById('discBox'),
      discBadge: document.getElementById('discBadge'),
      annualBlock: document.getElementById('annualBlock'),
      annualQtyHousing: document.getElementById('annualQtyHousing'),
      annualQtyCartridge: document.getElementById('annualQtyCartridge'),
      annualHousing: document.getElementById('annualHousing'),
      annualCartridge: document.getElementById('annualCartridge'),
      annualTotal: document.getElementById('annualTotal'),
    }

    function save(){ localStorage.setItem('refill_calc_v1', JSON.stringify(state)) }

    // ===== Build selects =====
    function build(){
      els.housingSelect.innerHTML = DATA.housings.map(h=>`<option value="${h.key}" ${h.key===state.housingKey?'selected':''}>${h.name}</option>`).join('')
      els.cartridgeSelect.innerHTML = DATA.cartridges.map(c=>`<option value="${c.key}" ${c.key===state.cartridgeKey?'selected':''}>${c.name}</option>`).join('')
      els.housingPack.value = state.housingPack
      els.cartridgePack.value = state.cartridgePack
      els.discount.value = state.discount
      els.customerView.checked = state.customerView
      els.qtyHousing.value = state.qtyHousing || ''
      els.qtyCartridge.value = state.qtyCartridge || ''
      els.qtyPeriod.value = state.qtyPeriod
      compute()
    }

    function getItem(arr,key){ return arr.find(x=>x.key===key) }

    // Fixed rounding: always DOWN to nearest 0.01
    function roundDownPenny(val){ return Math.floor((val + 1e-9) * 100) / 100 }

    function annualise(qty, period){
      if(!qty || qty<=0) return 0
      if(period==='day') return qty * 365
      if(period==='month') return qty * 12
      return qty // year
    }

    function compute(){
      const rate = (+state.discount||0) / 100
      const h = getItem(DATA.housings, state.housingKey)
      const c = getItem(DATA.cartridges, state.cartridgeKey)
      const hPrice = state.housingPack==='box' ? h.listBox : h.listEach
      const cPrice = state.cartridgePack==='box' ? c.listBox : c.listEach
      const base = (hPrice||0) + (cPrice||0)

      const hDisc = (hPrice||0) * rate
      const cDisc = (cPrice||0) * rate
      const hAfter = roundDownPenny((hPrice||0) - hDisc)
      const cAfter = roundDownPenny((cPrice||0) - cDisc)

      const totalDisc = (hPrice||0) + (cPrice||0) - (hAfter + cAfter)
      const subtotal = roundDownPenny(hAfter + cAfter)

      // Toggle customer view lines (also hide discount KPI box)
      const hide = !!state.customerView
      ;[els.lineHousing, els.lineHousingDisc, els.lineCartridge, els.lineCartridgeDisc, els.lineBase, els.lineTotalDisc, els.discBox].forEach(el=>{
        el.classList.toggle('hidden', hide)
      })

      // Write lines
      els.housingLine.textContent = `${h.name} — ${fmt.format(hPrice||0)} (${state.housingPack})`
      els.housingDisc.textContent = `− ${fmt.format(hDisc)}`
      els.housingAfter.textContent = fmt.format(hAfter)

      els.cartridgeLine.textContent = `${c.name} — ${fmt.format(cPrice||0)} (${state.cartridgePack})`
      els.cartridgeDisc.textContent = `− ${fmt.format(cDisc)}`
      els.cartridgeAfter.textContent = fmt.format(cAfter)

      els.base.textContent = fmt.format(base)
      els.discountAmt.textContent = `− ${fmt.format(totalDisc)}`
      els.yourPrice.textContent = fmt.format(subtotal)
      els.discBadge.textContent = `${(+state.discount||0).toFixed(1).replace(/\.0$/, '')}%`

      // Annual block (separate housing & cartridge quantities)
      const aH = annualise(+state.qtyHousing||0, state.qtyPeriod)
      const aC = annualise(+state.qtyCartridge||0, state.qtyPeriod)
      if(aH>0 || aC>0){
        els.annualBlock.classList.remove('hidden')
        els.annualQtyHousing.textContent = aH.toLocaleString('en-GB')
        els.annualQtyCartridge.textContent = aC.toLocaleString('en-GB')
        const annualH = roundDownPenny(hAfter * aH)
        const annualC = roundDownPenny(cAfter * aC)
        els.annualHousing.textContent = fmt.format(annualH)
        els.annualCartridge.textContent = fmt.format(annualC)
        els.annualTotal.textContent = fmt.format(roundDownPenny(annualH + annualC))
      } else {
        els.annualBlock.classList.add('hidden')
      }
    }

    // Wire events
    els.housingSelect.addEventListener('change', ()=>{ state.housingKey = els.housingSelect.value; save(); compute() })
    els.cartridgeSelect.addEventListener('change', ()=>{ state.cartridgeKey = els.cartridgeSelect.value; save(); compute() })
    els.housingPack.addEventListener('change', ()=>{ state.housingPack = els.housingPack.value; save(); compute() })
    els.cartridgePack.addEventListener('change', ()=>{ state.cartridgePack = els.cartridgePack.value; save(); compute() })
    els.discount.addEventListener('input', ()=>{ state.discount = +els.discount.value; save(); compute() })
    els.customerView.addEventListener('change', ()=>{ state.customerView = els.customerView.checked; save(); compute() })
    els.qtyHousing.addEventListener('input', ()=>{ state.qtyHousing = +els.qtyHousing.value; save(); compute() })
    els.qtyCartridge.addEventListener('input', ()=>{ state.qtyCartridge = +els.qtyCartridge.value; save(); compute() })
    els.qtyPeriod.addEventListener('change', ()=>{ state.qtyPeriod = els.qtyPeriod.value; save(); compute() })

    // Init
    build()

    // A2HS helper + PWA SW
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }
    let deferredPrompt
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e })
    document.getElementById('btnA2HS').addEventListener('click', async ()=>{
      try{ if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice } else { alert('Use your browser\'s Share menu → Add to Home Screen') } }catch{}
    })
  </script>
</body>
</html>
